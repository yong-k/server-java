# ì˜ˆì•½ í›„ ê²°ì œ ì§€ì—° â†’ ì„ì‹œ ë°°ì • í•´ì œ ë¡œì§ ë¶€ì •í™• (ë°°ì • íƒ€ì„ì•„ì›ƒ í•´ì œ ìŠ¤ì¼€ì¤„ëŸ¬)

## 1. ë¬¸ì œ ìƒí™©
- ì¢Œì„ ì˜ˆì•½ ì‹œ, ìƒíƒœëŠ” ```TEMP_RESERVED```ë¡œ ì„¤ì •ë˜ê³ , ```releasedAt```ì€ 5ë¶„ ë’¤ë¡œ ì§€ì •ë¨
- ```SeatStatusScheduler```ëŠ” 1ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ë©°, ì•„ë˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢Œì„ ìƒíƒœë¥¼ ë‹¨ê³„ë³„ë¡œ ë³€ê²½í•¨
  1. ```TEMP_RESERVED``` + 5ë¶„ ê²½ê³¼ â†’ ```EXPIRED```
  2. ```EXPIRED``` + 1ë¶„ ê²½ê³¼ â†’ ```HOLD```
  3. ```HOLD``` + 3ë¶„ ê²½ê³¼ â†’ ```AVAILABLE```
- ë™ì‹œì„± ë¬¸ì œ
  - ìŠ¤ì¼€ì¤„ëŸ¬ê°€ TEMP_RESERVED â†’ EXPIRED ìƒíƒœë¡œ ë³€ê²½ ì¤‘ì¼ ë•Œ
    ë™ì‹œì— ê²°ì œ ì„œë¹„ìŠ¤ê°€ pay() í˜¸ì¶œ ì‹œë„

### ğŸ” í…ŒìŠ¤íŠ¸
- ì½”ë“œ: SeatSchedulerConcurrencyTest.java
- ì‹œë‚˜ë¦¬ì˜¤
  - ì¢Œì„ì„ TEMP_RESERVED ìƒíƒœë¡œ ë§Œë“¤ê³ , releasedAtì„ ê³¼ê±°ë¡œ ì„¤ì •
  - ìŠ¤ì¼€ì¤„ëŸ¬ì™€ ê²°ì œë¥¼ ê°ê° ë³„ë„ ì“°ë ˆë“œì—ì„œ ë™ì‹œì— ì‹¤í–‰
  - ê¸°ëŒ€ ê²°ê³¼: ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ë¨¼ì € ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´, ê²°ì œ ì„œë¹„ìŠ¤ëŠ” ìƒíƒœ ê²€ì¦ì—ì„œ ì‹¤íŒ¨í•´ì•¼ í•¨
```java
@Test
void ê²°ì œì™€_ìŠ¤ì¼€ì¤„ëŸ¬_ì¶©ëŒ_í…ŒìŠ¤íŠ¸() throws InterruptedException {
    ExecutorService executor = Executors.newFixedThreadPool(2);
    CountDownLatch latch = new CountDownLatch(2);

    // ê²°ì œ
    executor.submit(() -> {
        try {
            reservationService.pay(new PaymentReqDto(seat.getId(), userId));
            log.info("ê²°ì œ ì„±ê³µ");
        } catch (Exception e) {
            log.info("ê²°ì œ ì‹¤íŒ¨");
        } finally {
            latch.countDown();
        }
    });

    // ìŠ¤ì¼€ì¤„ëŸ¬
    executor.submit(() -> {
        try {
            scheduler.updateSeatStatus();   // TEMP_RESERVED â†’ EXPIRED
            log.info("ìŠ¤ì¼€ì¤„ëŸ¬_ë™ì‹œì„±_í…ŒìŠ¤íŠ¸: ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì™„ë£Œ");
        } finally {
            latch.countDown();
        }
    });

    latch.await();
    executor.shutdown();

    Seat finalSeat = seatRepository.findById(seat.getId()).orElseThrow();
    if (finalSeat.getStatus() == SeatStatus.RESERVED) {
        // ê²°ì œ ë¨¼ì € ì²˜ë¦¬
        assertThat(finalSeat.getReleasedAt()).isNull();
    } else {
        // ìŠ¤ì¼€ì¤„ëŸ¬ ë¨¼ì € ì²˜ë¦¬
        assertThat(finalSeat.getStatus()).isIn(SeatStatus.EXPIRED, SeatStatus.HOLD, SeatStatus.AVAILABLE);
    }
}
```
### í…ŒìŠ¤íŠ¸ ê²°ê³¼
- ê²°ì œ ì‹¤íŒ¨ â†’ ê²°ì œ ì‹¤íŒ¨ ë¡œê·¸ ì¶œë ¥ë¨
- ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ì •ìƒì ìœ¼ë¡œ ìƒíƒœ ë³€ê²½ (EXPIRED) ìˆ˜í–‰
```java
[pool-2-thread-2] k.h.b.s.r.scheduler.SeatStatusScheduler  : ì¢Œì„ ë§Œë£Œ ì²˜ë¦¬ë¨ - seatId: 1, status: EXPIRED
[pool-2-thread-1] k.h.b.s.r.SeatSchedulerConcurrencyTest   : ê²°ì œ ì‹¤íŒ¨
[pool-2-thread-2] k.h.b.s.r.SeatSchedulerConcurrencyTest   : ìŠ¤ì¼€ì¤„ëŸ¬_ë™ì‹œì„±_í…ŒìŠ¤íŠ¸: ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì™„ë£Œ
```

## 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼: ì •í•©ì„± ë³´ì¥ í™•ì¸
í˜„ì¬ êµ¬ì¡°ëŠ” **ì„ ì í•œ ìª½ì´ ì„±ê³µí•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ë¡œ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ**ë˜ë¯€ë¡œ ë½ì„ ì ìš©í•˜ì§€ ì•Šì•„ë„ ë°ì´í„° ì •í•©ì„±ì´ ë³´ì¥ëœë‹¤ê³  íŒë‹¨
