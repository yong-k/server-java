# ë™ì‹œì„± í…ŒìŠ¤íŠ¸ - ê°™ì€ ì¢Œì„ì— ëŒ€í•´ ë™ì‹œì— ì˜ˆì•½ ìš”ì²­ â†’ ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ

## 1. ë¬¸ì œ ìƒí™©: ë™ì‹œ ìš”ì²­ ì‹œ ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ
- ê°™ì€ ì¢Œì„ì— ëŒ€í•´ ë™ì‹œì— ì˜ˆì•½ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, ì¤‘ë³µ ì˜ˆì•½ì´ ë°œìƒí•œë‹¤.
- ì—¬ëŸ¬ ëª…ì´ ë™ì‹œì— TEMP_RESERVED ìƒíƒœë¡œ ì˜ˆì•½ë¨ â†’ ë°ì´í„° ì •í•©ì„± ë¬¸ì œ ë°œìƒ


### ğŸ” í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
@Test
void ë™ì‹œì—_ê°™ì€_ì¢Œì„_ì˜ˆì•½_ì‹œë„() throws InterruptedException {
    int threadCount = 100;
    ExecutorService executor = Executors.newFixedThreadPool(threadCount);
    CountDownLatch latch = new CountDownLatch(threadCount);

    List<SeatReservationRespDto> successList = new ArrayList<>();

    doNothing().when(tokenValidator).validateToken(any(), anyInt());

    for (int i = 0; i < threadCount; i++) {
        UUID userId = UUID.randomUUID();
        executor.submit(() -> {
            try {
                SeatReservationReqDto reqDto = new SeatReservationReqDto(seat.getId(), userId);
                SeatReservationRespDto respDto = reservationService.reserveSeat(reqDto);
                successList.add(respDto);
            } catch (Exception e) {
            } finally {
                latch.countDown();
            }
        });
    }

    latch.await();
    executor.shutdown();

    // ë™ì‹œì— ê°™ì€ ì¢Œì„ ì˜ˆì•½ì•ˆë˜ë©´ ì„±ê³µê°œìˆ˜ëŠ” 1ì´ì—¬ì•¼ í•¨.
    assertThat(successList.size()).isEqualTo(1);
    log.info("ì„±ê³µ ê°œìˆ˜: {}", successList.size());
}
```
### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
org.opentest4j.AssertionFailedError: 
expected: 1
 but was: 10
Expected :1
Actual   :10
```
| í•­ëª©          | ì˜ë¯¸                                             |
|---------------|------------------------------------------------|
| `expected : 1` | ê¸°ëŒ€ ê²°ê³¼ â†’ ë™ì¼ ì¢Œì„ ì˜ˆì•½ì€ 1ê±´ì´ì–´ì•¼ í•œë‹¤                     |
| `actual : 10`  | ì‹¤ì œ ê²°ê³¼ â†’ 10ê°œì˜ ìŠ¤ë ˆë“œê°€ TEMP_RESERVED ìƒíƒœë¡œ ë™ì‹œì— ì¢Œì„ í™•ë³´  |


## 2. í•´ê²° ì „ëµ: ë¹„ê´€ì  ë½(Pessimistic Lock) ì ìš©
- ì¢Œì„ ì¡°íšŒí•  ë•Œ **row-level ë½**ì„ ê±´ë‹¤.
- JPAì˜ `@Lock(LockModeType.PESSIMISTIC_WRITE)` ì‚¬ìš©
### ğŸ“Œ ì ìš© ì½”ë“œ
#### SeatRepository.java
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT s FROM Seat s WHERE s.id = :seatId")
Optional<Seat> findByIdForUpdate(@Param("seatId") int seatId);
```
#### ReservationService.java
```java
@Transactional
public SeatReservationRespDto reserveSeat(SeatReservationReqDto dto) {
    Seat seat = seatRepository.findByIdForUpdate(seatId)
            .orElseThrow(() -> new DataNotFoundException("ì¢Œì„ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: seatId = " + seatId));
}
```

## 3. í•´ê²° ê²°ê³¼: í…ŒìŠ¤íŠ¸ ì„±ê³µ
```java
INFO 23112 --- [main] k.h.b.s.r.ReservationConcurrencyTest: ì„±ê³µ ê°œìˆ˜: 1
```
- `@Lock(PESSIMISTIC_WRITE)` ì ìš© í›„ í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰
- ê²°ê³¼: **ì˜¤ì§ 1ê±´ì˜ TEMP_RESERVEDë§Œ ë°œìƒ â†’ ë‚˜ë¨¸ì§€ëŠ” ì˜ˆì™¸ë¡œ ì‹¤íŒ¨**
- âœ… Test Passed â†’ ë™ì‹œì„± ë¬¸ì œ í•´ê²° í™•ì¸