# ν¬μΈνΈ μ¶©μ „/μ°¨κ° λ™μ‹μ„± λ¬Έμ 

## 1. λ¬Έμ  μƒν™©: μ¶©λ λ°μƒ μ‹ μ •ν•©μ„± μ¤λ¥
- λ™μ‹μ— κ°™μ€ μ μ €μ— λ€ν•΄ ν¬μΈνΈ μ¶©μ „/μ°¨κ°μ„ μ”μ²­ν•λ” κ²½μ°, λ™μ‹μ„± μ μ–΄κ°€ μ—†μΌλ©΄ λ‹¤μκ³Ό κ°™μ€ λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.
  - μ”μ•΅ μ‚¬μ© μ¤‘ μ¶©λ λ°μƒ β†’ **μ΄κ³Ό μ¶©μ „**
  - μ”μ•΅ μ°¨κ° μ¤‘ μ¶©λ λ°μƒ β†’ **μμ μ”μ•΅**


### π” ν…μ¤νΈ
- μ½”λ“: PointConcurrencyTest.java
```java
@Test
void λ™μ‹μ—_κ°™μ€_μ μ €_ν¬μΈνΈ_μ°¨κ°() throws InterruptedException {
            :
    // μ΄κΈ° ν¬μΈνΈ 5_000μ›
    // 100μ›μ”© 100λ² μ°¨κ° β†’ μ΄ 10_000μ› μ°¨κ° μ”μ²­ β†’ μ •ν•©μ„± μ¤λ¥ μ λ„
    assertThat(actualPoint).isEqualTo(expectedPoint);
}
```
```java
@Test
void λ™μ‹μ—_κ°™μ€_μ μ €_ν¬μΈνΈ_μ¶©μ „() throws InterruptedException {
        :
    // μ΄κΈ° ν¬μΈνΈ 1_950_000μ›
    // 30,000μ›μ”© 20λ² μ¶©μ „ β†’ μ΄ 600,000μ› μ¶©μ „ μ”μ²­ β†’ μµλ€ λ³΄μ ν•λ„ μ΄κ³Ό μ λ„
    assertThat(actualPoint).isEqualTo(expectedPoint);  
}
```
### ν…μ¤νΈ κ²°κ³Ό
| ν•­λ©            | μλ―Έ                                              |
| ------------- | ----------------------------------------------- |
| μ°¨κ° μ„±κ³µ κ±΄μ: 100 | μ‹¤μ λ΅λ” 5,000μ›λ°–μ— μ—†λ”λ° 10,000μ› μ°¨κ° μ‹λ„ β†’ μ •ν•©μ„± μ¤λ¥ κ°€λ¥μ„± μμ |
| μ¶©μ „ μ„±κ³µ κ±΄μ: 10  | μµλ€ ν•λ„ 2,000,000 μ΄κ³Όλ  μ μμ β†’ μ΄κ³Ό μ¶©μ „ λ°μƒ κ°€λ¥μ„± μμ      |


## 2. ν•΄κ²° μ „λµ: μ΅°κ±΄λ¶€ UPDATE μ μ©
- User ν…μ΄λΈ”μ point μ»¬λΌμ— λ€ν•΄ μ΅°κ±΄λ¶€ UPDATEλ¥Ό μ μ©ν•μ—¬, λ™μ‹μ„± λ¬Έμ λ¥Ό λ°©μ§€ν•κ³  μ •ν•©μ„±μ„ μ μ§€ν•λ‹¤.
- JPQLμ @Queryλ¥Ό μ‚¬μ©ν•μ—¬ λ…μ‹μ μΌλ΅ μ΅°κ±΄ μ„¤μ •
- μ΅°κ±΄ λ¶μΌμΉ μ‹ μ—…λ°μ΄νΈ μ‹¤ν¨ β†’ μμ™Έ μ²λ¦¬λ΅ μ°¨λ‹¨
 
### π“ μ μ© μ½”λ“
#### PointRepository.java
```java
@Modifying
@Query("""
        UPDATE User u
        SET u.point = u.point + :amount
        WHERE u.id = :userId
          AND u.point + :amount <= :maxPoint  
    """)
int addPoint(@Param("userId") UUID userId, @Param("amount") int amount, @Param("maxPoint") int maxPoint);

@Modifying
@Query("""
        UPDATE User u
        SET u.point = u.point - :amount
        WHERE u.id = :userId
          AND u.point >= :amount
    """)
int usePoint(@Param("userId") UUID userId, @Param("amount") int amount);
```
#### PointService.java

- μ‹¤ν¨ μ‹ μμ™Έ μ²λ¦¬ 
```java
if (updated == 0) 
    throw new PointPolicyViolationException("μ°¨κ° μ‹¤ν¨: λ™μ‹μ„± μ¶©λ OR ν¬μΈνΈ λ¶€μ΅±");
```

## 3. ν…μ¤νΈ κ²°κ³Ό: μ •ν•©μ„± λ³΄μ¥ ν™•μΈ
```java
[main] k.h.b.server.point.PointConcurrencyTest : μ°¨κ° μ„±κ³µ κ±΄μ = 50
[main] k.h.b.server.point.PointConcurrencyTest : μ¶©μ „ μ„±κ³µ κ±΄μ = 1
```
- κΈ°λ€ν–λ κ²°κ³Ό
  - μµλ€ μ°¨κ° κ°€λ¥ νμ: 5,000 / 100 = 50ν
  - μµλ€ μ¶©μ „ κ°€λ¥ νμ: (2,000,000 - 1,950,000) / 30,000 = 1ν
- **μ΅°κ±΄λ¶€ UPDATEλ΅ μΈν•΄ μ΄κ³Ό μ”μ²­μ€ μ‹¤ν¨**
- β… Test Passed β†’ λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥